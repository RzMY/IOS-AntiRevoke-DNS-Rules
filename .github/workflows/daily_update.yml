name: Daily iOS Anti-Revoke Profile Update

on:
  schedule:
    # Run at 00:00 UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        default: false

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write SSL certificates
        env:
          SSL_CERT: ${{ secrets.SSL_CERT }}
          SSL_KEY: ${{ secrets.SSL_KEY }}
        run: |
          echo "$SSL_CERT" > fullchain.pem
          echo "$SSL_KEY" > privkey.pem
          chmod 600 fullchain.pem privkey.pem
          openssl x509 -in fullchain.pem -text -noout > /dev/null || echo "Warning: Certificate validation failed"

      - name: Verify OpenSSL
        run: |
          openssl version
          which openssl

      - name: Run update pipeline
        run: |
          python main.py
        env:
          SSL_CERT_PATH: fullchain.pem
          SSL_KEY_PATH: privkey.pem

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet output/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          git status

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f fullchain.pem privkey.pem

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add output/
          git commit -m "chore: update iOS Anti-Revoke profiles

          - Generated new .mobileconfig profiles
          - Updated filter rules for all proxy tools
          - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          git push

      - name: Create pull request (optional alternative)
        if: steps.changes.outputs.has_changes == 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: update iOS Anti-Revoke profiles'
          title: 'chore: daily iOS Anti-Revoke profile update'
          body: |
            ## Changes
            - Updated iOS Anti-Revoke .mobileconfig profiles
            - Regenerated filter rules for Quantumult X, Surge, Loon, and Shadowrocket
            - Updated domain blocklist
            
            **Generated by:** GitHub Actions
            **Time:** ${{ github.event.repository.updated_at }}
          branch: auto/revoke-profiles-update
          delete-branch: true
          labels: 'automated,profiles'
          assignees: |
            ${{ github.repository_owner }}

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: profiles-and-rules
          path: output/
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "## iOS Anti-Revoke Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          
          if [ -f output/metadata.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Build Details" >> $GITHUB_STEP_SUMMARY
            cat output/metadata.json >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f output/domains.txt ]; then
            DOMAIN_COUNT=$(wc -l < output/domains.txt)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Domains:** $DOMAIN_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
